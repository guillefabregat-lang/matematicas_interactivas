import React, { useState, useMemo } from 'react';

const FactorVisualization = () => {
  const [num1, setNum1] = useState(12);
  const [num2, setNum2] = useState(18);
  const [hoveredColumn, setHoveredColumn] = useState(null);

  // 1. L√≥gica de Factorizaci√≥n
  const factorize = (n) => {
    if (n <= 1) return [];
    const factors = [];
    let temp = n;
    for (let i = 2; i * i <= temp; i++) {
      while (temp % i === 0) {
        factors.push(i);
        temp /= i;
      }
    }
    if (temp > 1) factors.push(temp);
    return factors;
  };

  const getGCD = (a, b) => {
    if (b === 0) return a;
    return getGCD(b, a % b);
  };

  const getLCM = (a, b) => {
    if (a === 0 || b === 0) return 0;
    return (a * b) / getGCD(a, b);
  };

  const factors1 = useMemo(() => factorize(num1), [num1]);
  const factors2 = useMemo(() => factorize(num2), [num2]);
  const gcd = useMemo(() => getGCD(num1, num2), [num1, num2]);
  const lcm = useMemo(() => getLCM(num1, num2), [num1, num2]);

  // 2. L√≥gica para separar factores en 3 grupos (Venn Diagram)
  const vennData = useMemo(() => {
    const f1Copy = [...factors1];
    const f2Copy = [...factors2];
    
    const common = [];
    const unique1 = [];
    const unique2 = [];

    const tempF2 = [...f2Copy];
    
    f1Copy.forEach(f => {
      const matchIndex = tempF2.indexOf(f);
      if (matchIndex !== -1) {
        common.push(f);
        tempF2.splice(matchIndex, 1);
      } else {
        unique1.push(f);
      }
    });

    unique2.push(...tempF2);

    return { unique1, common, unique2 };
  }, [factors1, factors2]);

  // 3. Generador de posiciones para el Diagrama de Venn
  const generateVennPositions = (items, centerX, centerY, radius, color, type) => {
    if (items.length === 0) return [];
    
    if (items.length === 1) {
      return [{ x: centerX, y: centerY, val: items[0], color, type }];
    }

    return items.map((val, i) => {
      const angle = (i / items.length) * 2 * Math.PI - (Math.PI / 2);
      return {
        x: centerX + Math.cos(angle) * radius,
        y: centerY + Math.sin(angle) * radius,
        val,
        color,
        type
      };
    });
  };

  const vennPositions = [
    ...generateVennPositions(vennData.unique1, 180, 200, 40, "blue", "unique1"),
    ...generateVennPositions(vennData.common, 300, 200, 30, "yellow", "common"),
    ...generateVennPositions(vennData.unique2, 420, 200, 40, "green", "unique2"),
  ];

  // 4. L√≥gica para el MCM (Alineaci√≥n de Columnas)
  const lcmColumns = useMemo(() => {
    const cols = [];
    const f1 = [...factors1];
    const f2 = [...factors2];
    
    const allPrimes = Array.from(new Set([...f1, ...f2])).sort((a, b) => a - b);

    allPrimes.forEach(prime => {
      const count1 = f1.filter(x => x === prime).length;
      const count2 = f2.filter(x => x === prime).length;
      const maxCount = Math.max(count1, count2);

      for (let i = 0; i < maxCount; i++) {
        cols.push({
          prime,
          hasIn1: i < count1,
          hasIn2: i < count2,
          isResult: true
        });
      }
    });

    return cols;
  }, [factors1, factors2]);

  return (
    <div className="p-8 bg-slate-50 min-h-screen font-sans">
      <div className="max-w-5xl mx-auto space-y-8">
        {/* BOT√ìN VOLVER AL MEN√ö */}
                    <div className="flex items-center justify-between mb-4">
                        <a href="index.html" className="flex items-center text-purple-700 font-bold hover:text-purple-900 transition-colors">
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                            Volver al Men√∫
                        </a>
                        <h1 className="text-2xl font-bold text-gray-800">Factorizaci√≥n Prima</h1>
                    </div>
        {/* Header e Inputs */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <h1 className="text-3xl font-bold text-slate-800 text-center mb-6">Calculadora Visual de Factores</h1>
          
          <div className="flex justify-center gap-8 items-end mb-6 flex-wrap">
            <div className="text-center">
              <label className="block text-sm font-semibold text-blue-600 mb-2">N√∫mero A</label>
              <input 
                type="number" 
                value={num1} 
                onChange={(e) => setNum1(Math.max(1, parseInt(e.target.value) || 0))}
                className="w-24 text-center text-3xl font-bold border-2 border-blue-200 rounded-lg p-2 focus:border-blue-500 outline-none text-slate-700"
              />
              <div className="mt-2 text-sm text-slate-500 font-mono">
                {factors1.length > 0 ? factors1.join(' √ó ') : '1'}
              </div>
            </div>

            <div className="pb-4 text-slate-300 text-2xl font-bold">&</div>

            <div className="text-center">
              <label className="block text-sm font-semibold text-green-600 mb-2">N√∫mero B</label>
              <input 
                type="number" 
                value={num2} 
                onChange={(e) => setNum2(Math.max(1, parseInt(e.target.value) || 0))}
                className="w-24 text-center text-3xl font-bold border-2 border-green-200 rounded-lg p-2 focus:border-green-500 outline-none text-slate-700"
              />
              <div className="mt-2 text-sm text-slate-500 font-mono">
                {factors2.length > 0 ? factors2.join(' √ó ') : '1'}
              </div>
            </div>
          </div>
        </div>

        {/* VISUALIZACI√ìN 1: MCD (Venn Diagram) */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h2 className="text-xl font-bold text-slate-700">MCD: Diagrama de Venn</h2>
            <div className="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full font-bold text-lg">
              MCD = {gcd}
            </div>
          </div>
          
          <div className="relative border border-slate-100 rounded-lg bg-slate-50 flex flex-col items-center p-6">
             <svg width="100%" height="350" viewBox="0 0 600 350" preserveAspectRatio="xMidYMid meet">
                {/* C√≠rculo Izquierdo (A) */}
                <circle cx="240" cy="160" r="110" fill="rgba(59, 130, 246, 0.1)" stroke="#3b82f6" strokeWidth="2" />
                <text x="140" y="40" fill="#3b82f6" fontWeight="bold" fontSize="14">Num A ({num1})</text>
                
                {/* C√≠rculo Derecho (B) */}
                <circle cx="360" cy="160" r="110" fill="rgba(34, 197, 94, 0.1)" stroke="#22c55e" strokeWidth="2" />
                <text x="390" y="40" fill="#22c55e" fontWeight="bold" fontSize="14">Num B ({num2})</text>

                {/* Bolas de factores */}
                {vennPositions.map((pos, i) => (
                  <g key={i}>
                    <circle 
                      cx={pos.x} 
                      cy={pos.y} 
                      r="18" 
                      fill={pos.type === 'common' ? '#facc15' : pos.type === 'unique1' ? '#3b82f6' : '#22c55e'} 
                      className="transition-all duration-500 ease-out hover:r-24 cursor-pointer"
                    />
                    <text 
                      x={pos.x} 
                      y={pos.y} 
                      dy=".35em" 
                      textAnchor="middle" 
                      fill={pos.type === 'common' ? '#713f12' : 'white'} 
                      fontWeight="bold"
                      fontSize="16"
                    >
                      {pos.val}
                    </text>
                  </g>
                ))}
                
                {vennData.common.length === 0 && (
                  <text x="300" y="160" textAnchor="middle" fill="#94a3b8" fontSize="12" fontStyle="italic">Sin factores comunes</text>
                )}
             </svg>

             {/* C√°lculo del MCD */}
             {vennData.common.length > 0 && (
               <div className="mt-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-center w-full">
                 <p className="text-sm text-slate-600 mb-2">Factores comunes:</p>
                 <p className="text-lg font-bold text-yellow-700">
                   {vennData.common.join(' √ó ')} = <span className="text-2xl text-yellow-800">{gcd}</span>
                 </p>
               </div>
             )}
          </div>
          <p className="text-center text-sm text-slate-500 mt-4">
            El MCD es el producto de los n√∫meros en la <span className="font-bold text-yellow-600">intersecci√≥n amarilla</span>.
          </p>
        </div>

        {/* VISUALIZACI√ìN 2: MCM (Alineaci√≥n de Columnas) */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <div className="flex justify-between items-center mb-8 flex-wrap gap-2">
            <h2 className="text-xl font-bold text-slate-700">MCM: Alineaci√≥n de Factores</h2>
            <div className="bg-purple-100 text-purple-800 px-4 py-2 rounded-full font-bold text-lg">
              MCM = {lcm}
            </div>
          </div>

          <div className="overflow-x-auto pb-4">
            <div className="flex justify-center items-end gap-1 min-w-min px-4">
              {/* Etiquetas de filas */}
              <div className="flex flex-col gap-1 mr-4 text-right text-xs font-bold text-slate-400 justify-end pb-[65px]">
                 <div className="h-10 flex items-center justify-end text-blue-600 text-sm">A</div>
                 <div className="h-10 flex items-center justify-end text-green-600 text-sm">B</div>
                 <div className="h-1 border-b border-slate-300 w-full my-1"></div>
              </div>

              {/* Columnas din√°micas */}
              {lcmColumns.map((col, idx) => (
                <div 
                  key={idx} 
                  className="flex flex-col items-center gap-1 group cursor-pointer"
                  onMouseEnter={() => setHoveredColumn(idx)}
                  onMouseLeave={() => setHoveredColumn(null)}
                >
                  
                  {/* Casilla N√∫mero 1 */}
                  <div className={`
                    w-9 h-9 rounded-md flex items-center justify-center font-bold text-sm transition-all transform
                    ${col.hasIn1 ? 'bg-blue-100 text-blue-700 border-2 border-blue-300 shadow-md' : 'bg-transparent border-2 border-dashed border-slate-200'}
                    ${hoveredColumn === idx ? 'scale-110 shadow-lg' : ''}
                  `}>
                    {col.hasIn1 ? col.prime : '‚Äî'}
                  </div>

                  {/* Casilla N√∫mero 2 */}
                  <div className={`
                    w-9 h-9 rounded-md flex items-center justify-center font-bold text-sm transition-all transform
                    ${col.hasIn2 ? 'bg-green-100 text-green-700 border-2 border-green-300 shadow-md' : 'bg-transparent border-2 border-dashed border-slate-200'}
                    ${hoveredColumn === idx ? 'scale-110 shadow-lg' : ''}
                  `}>
                    {col.hasIn2 ? col.prime : '‚Äî'}
                  </div>

                  {/* L√≠nea divisoria y flecha */}
                  <div className={`h-6 w-[2px] transition-all ${hoveredColumn === idx ? 'bg-purple-500' : 'bg-purple-200'} relative my-0.5`}>
                    <div className={`absolute bottom-0 -left-1 w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[5px] ${hoveredColumn === idx ? 'border-t-purple-500' : 'border-t-purple-200'}`}></div>
                  </div>

                  {/* Resultado MCM */}
                  <div className={`w-9 h-9 rounded-md text-white flex items-center justify-center font-bold text-sm shadow-md transition-all transform
                    ${hoveredColumn === idx ? 'bg-purple-700 scale-125 shadow-lg' : 'bg-purple-600'}`}>
                    {col.prime}
                  </div>

                  {/* Tooltip al hover */}
                  {hoveredColumn === idx && (
                    <div className="absolute bottom-full mb-2 bg-slate-800 text-white text-xs rounded px-2 py-1 whitespace-nowrap z-10">
                      {col.hasIn1 && col.hasIn2 ? 'En ambos' : col.hasIn1 ? 'Solo en A' : 'Solo en B'}
                    </div>
                  )}
                </div>
              ))}
              
              {/* Signo igual y resultado total */}
               <div className="flex flex-col justify-end pb-1 ml-4 text-center">
                  <span className="text-3xl font-bold text-purple-600">=</span>
                  <span className="text-2xl font-bold text-purple-700 mt-2">{lcm}</span>
               </div>
            </div>
          </div>

          <p className="text-center text-sm text-slate-500 mt-6">
            Para el MCM, alineamos los factores iguales. <span className="font-bold text-purple-600">Toma el m√°ximo</span> de cada columna (pasa el rat√≥n para verlo).
          </p>
        </div>

        {/* INFORMACI√ìN EDUCATIVA */}
        <div className="bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border-2 border-slate-200 p-6">
          <h3 className="text-lg font-bold text-slate-700 mb-4">¬øC√≥mo funciona?</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-bold text-blue-600 mb-2">üü° MCD (M√°ximo Com√∫n Divisor)</h4>
              <p className="text-sm text-slate-600">
                Es el producto de los <strong>factores que aparecen en ambos n√∫meros</strong>. Nos dice el n√∫mero m√°s grande que divide a ambos.
              </p>
            </div>
            <div>
              <h4 className="font-bold text-purple-600 mb-2">üü£ MCM (M√≠nimo Com√∫n M√∫ltiplo)</h4>
              <p className="text-sm text-slate-600">
                Se toma el <strong>m√°ximo de cada factor primo</strong>. Es el n√∫mero m√°s peque√±o que es m√∫ltiplo de ambos.
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
};

export default FactorVisualization;
